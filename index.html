<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>L'Académie - Mobile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,400;0,700;1,400&family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Montserrat', 'sans-serif'], serif: ['Merriweather', 'serif'] },
                    colors: { 
                        frBlue: '#002654', 
                        frRed: '#ED2939', 
                        frCream: '#F5F5DC', 
                        gold: '#D4AF37',
                        bronze: '#CD7F32',
                        silver: '#C0C0C0'
                    },
                    boxShadow: { 'card': '0 10px 15px -3px rgba(0, 0, 0, 0.1)', 'btn': '0px 4px 0px 0px rgba(0,0,0,0.3)' }
                }
            }
        }
    </script>

<style>
    /* Mobile optimization */
    body { overscroll-behavior-y: none; -webkit-tap-highlight-color: transparent; }
    
    .perspective-1000 { perspective: 1000px; }
    .transform-style-3d { transform-style: preserve-3d; }
    .backface-hidden { backface-visibility: hidden; }
    .rotate-y-180 { transform: rotateY(180deg); }
    
    .loader { border: 4px solid #f3f3f3; border-top: 4px solid #002654; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .animate-slide-in { animation: slideIn 0.3s ease-out forwards; }
    
    /* Content Styles */
    .lesson-step h2 { color: #002654; font-weight: 700; margin-bottom: 0.5em; font-size: 1.25em; font-family: 'Merriweather', serif; }
    @media(min-width: 640px) { .lesson-step h2 { font-size: 1.5em; } }
    
    .lesson-step p { margin-bottom: 1em; line-height: 1.6; color: #374151; font-size: 1rem; }
    @media(min-width: 640px) { .lesson-step p { font-size: 1.1rem; line-height: 1.8; } }

    .lesson-step ul { list-style-type: disc; padding-left: 1.2em; margin-bottom: 1em; }
    .lesson-step strong { color: #ED2939; font-weight: 700; }
    
    /* Tables */
    .conjugation-table { width: 100%; border-collapse: collapse; margin: 1em 0; font-size: 0.9rem; }
    .conjugation-table td, .conjugation-table th { border: 1px solid #e5e7eb; padding: 6px; }
    .conjugation-table th { background-color: #f3f4f6; color: #002654; }
    
    textarea, input { font-size: 16px !important; }
</style>
</head>
<body class="bg-gray-50 text-gray-800 h-[100dvh] flex flex-col overflow-hidden">

    <!-- NAVBAR -->
    <nav class="bg-frBlue text-white shadow-lg z-50 relative shrink-0">
        <div class="max-w-5xl mx-auto px-4 h-14 flex justify-between items-center">
            <div class="flex items-center gap-2 cursor-pointer active:opacity-70 transition" onclick="app.renderMap()">
                <i class="fa-solid fa-landmark text-gold text-xl"></i>
                <h1 class="font-bold text-base tracking-wider uppercase">L'Académie</h1>
            </div>
            <button onclick="app.renderFlashcards()" class="bg-white/10 active:bg-white/20 text-white px-3 py-1.5 rounded-lg text-xs font-bold transition flex items-center gap-2">
                <i class="fa-solid fa-layer-group text-gold"></i> <span>Révisions</span>
            </button>
        </div>
        <!-- Flag Strip -->
        <div class="h-1 w-full flex"><div class="w-1/3 bg-blue-600"></div><div class="w-1/3 bg-white"></div><div class="w-1/3 bg-red-600"></div></div>
    </nav>

    <!-- MAIN CONTENT -->
    <main id="app-container" class="flex-1 overflow-y-auto relative bg-[#fdfbf7] w-full">
        <div class="h-full flex flex-col items-center justify-center">
            <div class="loader"></div>
            <p class="text-gray-500 mt-2 text-sm">Chargement...</p>
        </div>
    </main>

    <script>
        const app = {
            container: document.getElementById('app-container'),
            modules: [],
            // Progress is now an Object { lessonId: count }
            progress: {}, 
            userVocab: JSON.parse(localStorage.getItem('acad_user_vocab') || '[]'),
            baseUrl: 'https://clement-torti.github.io/french-quest/', 
            
            // State
            lessonSteps: [],
            currentStepIdx: 0,
            currentLessonMeta: null,
            
            // Review State
            reviewDeck: [],
            reviewIndex: 0,
    
            async init() {
                // --- MIGRATION LOGIC ---
                const rawProgress = JSON.parse(localStorage.getItem('acad_progress') || '{}');
                if (Array.isArray(rawProgress)) {
                    // Convert old array format [1, 2] to object {1: 1, 2: 1}
                    const newProgress = {};
                    rawProgress.forEach(id => newProgress[id] = 1);
                    this.progress = newProgress;
                    localStorage.setItem('acad_progress', JSON.stringify(this.progress));
                } else {
                    this.progress = rawProgress;
                }
                // -----------------------

                await this.discoverModules();
                let resizeTimer;
                window.addEventListener('resize', () => {
                    clearTimeout(resizeTimer);
                    resizeTimer = setTimeout(() => this.drawMapPath(), 100);
                });
            },
    
            // --- 1. DISCOVERY ---
            async discoverModules() {
                let id = 1;
                let searching = true;
                while (searching) {
                    const url = `${this.baseUrl}lesson${id}.html`;
                    try {
                        const res = await fetch(url);
                        if (res.ok) {
                            const text = await res.text();
                            const parser = new DOMParser();
                            const doc = parser.parseFromString(text, 'text/html');
                            const jsonScript = doc.getElementById('lesson-data');
                            if (jsonScript) {
                                const data = JSON.parse(jsonScript.textContent);
                                this.modules.push({ id: id, url: url, ...data });
                            }
                            id++;
                        } else { searching = false; }
                    } catch (e) { searching = false; }
                }
                if (this.modules.length === 0) this.container.innerHTML = `<div class="p-10 text-center">No lessons found.</div>`;
                else this.renderMap();
            },
    
            // --- 2. MAP RENDERING ---
            renderMap() {
                let nodes = '';
                this.modules.forEach((mod, i) => {
                    const count = this.progress[mod.id] || 0;
                    const offset = i % 2 === 0 ? '-translate-x-8 sm:-translate-x-12' : 'translate-x-8 sm:translate-x-12';
                    
                    let colorClass, iconClass, borderClass, medalLabel;

                    if (count === 0) {
                        // Default (Not started)
                        colorClass = 'bg-frBlue text-white';
                        borderClass = 'border-blue-900';
                        iconClass = mod.icon || 'fa-star';
                        medalLabel = '';
                    } else if (count === 1) {
                        // BRONZE
                        colorClass = 'bg-bronze text-white';
                        borderClass = 'border-[#8b4513]';
                        iconClass = 'fa-check';
                        medalLabel = '<div class="absolute -top-2 -right-2 bg-bronze text-white text-[9px] font-bold px-1.5 py-0.5 rounded-full border border-white shadow-sm">I</div>';
                    } else if (count === 2) {
                        // SILVER
                        colorClass = 'bg-silver text-gray-700';
                        borderClass = 'border-gray-500';
                        iconClass = 'fa-check-double';
                        medalLabel = '<div class="absolute -top-2 -right-2 bg-silver text-gray-700 text-[9px] font-bold px-1.5 py-0.5 rounded-full border border-white shadow-sm">II</div>';
                    } else {
                        // GOLD (3+)
                        colorClass = 'bg-gold text-white';
                        borderClass = 'border-yellow-600';
                        iconClass = 'fa-trophy';
                        medalLabel = '<div class="absolute -top-2 -right-2 bg-gold text-white text-[9px] font-bold px-1.5 py-0.5 rounded-full border border-white shadow-sm"><i class="fa-solid fa-crown text-[8px]"></i></div>';
                    }

                    nodes += `
                    <div class="flex flex-col items-center mb-16 relative z-10 pointer-events-none w-full">
                        <div class="pointer-events-auto flex flex-col items-center transition-transform duration-300 ${offset}" id="node-${i}">
                            <div class="mb-2 bg-white/90 backdrop-blur px-2 py-1 rounded shadow text-[10px] font-bold text-frBlue uppercase tracking-wider border border-gray-100">${mod.title}</div>
                            <button onclick="app.loadLesson(${i})" 
                                class="relative w-16 h-16 sm:w-20 sm:h-20 rounded-full text-2xl sm:text-3xl border-b-4 shadow-xl active:scale-95 transition-all active:translate-y-1 ${colorClass} ${borderClass}">
                                <i class="fa-solid ${iconClass}"></i>
                                ${medalLabel}
                            </button>
                            ${count > 0 ? `<div class="mt-1 text-[10px] font-bold text-gray-400 uppercase tracking-widest">${count === 1 ? 'Bronce' : (count === 2 ? 'Plata' : 'Oro')}</div>` : ''}
                        </div>
                    </div>`;
                });

                nodes += `
                <div class="w-full flex justify-center pb-12 relative z-20">
                    <button onclick="app.copyPlan(this)" class="bg-white border border-gray-300 text-gray-600 px-6 py-3 rounded-full text-xs font-bold shadow-md active:scale-95 transition flex items-center gap-2">
                        <i class="fa-solid fa-copy text-frBlue"></i>
                        <span>Copier le programme</span>
                    </button>
                </div>`;

                this.container.innerHTML = `
                    <div class="min-h-full py-10 relative overflow-x-hidden bg-[#fdfbf7]">
                        <svg id="map-svg" class="absolute inset-0 w-full h-full pointer-events-none"><path id="map-path" d="" fill="none" stroke="#cbd5e1" stroke-width="4" stroke-dasharray="8 8" stroke-linecap="round"/></svg>
                        <div class="max-w-md mx-auto flex flex-col items-center w-full overflow-hidden">${nodes}</div>
                    </div>`;
                setTimeout(() => this.drawMapPath(), 100);
            },

            async copyPlan(btnElement) {
                if (this.modules.length === 0) return;
                let content = "L'ACADÉMIE - PROGRAMME COMPLET\n================================\n\n";
                this.modules.forEach(mod => {
                    const count = this.progress[mod.id] || 0;
                    const status = count === 0 ? "[ ]" : (count === 1 ? "[BRONCE]" : (count === 2 ? "[PLATA]" : "[ORO]"));
                    const desc = mod.desc ? mod.desc : "Pas de description disponible.";
                    content += `${status} LEÇON ${mod.id}: ${mod.title.toUpperCase()}\n`;
                    content += `Description: ${desc}\n`;
                    content += `--------------------------------\n`;
                });

                try {
                    await navigator.clipboard.writeText(content);
                    const originalContent = btnElement.innerHTML;
                    const originalClasses = btnElement.className;
                    btnElement.innerHTML = `<i class="fa-solid fa-check text-green-600"></i> <span class="text-green-600">Copié !</span>`;
                    btnElement.classList.add('border-green-500', 'bg-green-50');
                    setTimeout(() => {
                        btnElement.innerHTML = originalContent;
                        btnElement.className = originalClasses;
                    }, 2000);
                } catch (err) {
                    console.error('Failed to copy: ', err);
                    alert("Impossible de copier le texte automatiquement.");
                }
            },
    
            drawMapPath() {
                const path = document.getElementById('map-path');
                if(!path || this.modules.length < 2) return;
                const contRect = this.container.getBoundingClientRect();
                let d = '';
                for(let i=0; i<this.modules.length-1; i++) {
                    const currEl = document.getElementById(`node-${i}`);
                    const nextEl = document.getElementById(`node-${i+1}`);
                    if(!currEl || !nextEl) continue;
                    const curr = currEl.getBoundingClientRect();
                    const next = nextEl.getBoundingClientRect();
                    const x1 = curr.left + curr.width/2;
                    const y1 = curr.top + curr.height/2 - contRect.top + this.container.scrollTop;
                    const x2 = next.left + next.width/2;
                    const y2 = next.top + next.height/2 - contRect.top + this.container.scrollTop;
                    if(i===0) d += `M ${x1} ${y1} `;
                    d += `C ${x1} ${y1 + (y2-y1)/2}, ${x2} ${y1 + (y2-y1)/2}, ${x2} ${y2} `;
                }
                path.setAttribute('d', d);
            },
    
            // --- 3. LESSON ENGINE ---
            async loadLesson(index) {
                const mod = this.modules[index];
                this.container.innerHTML = `<div class="h-full flex items-center justify-center"><div class="loader"></div></div>`;
                
                try {
                    let summaryStep = null;
                    if (index > 0) {
                        try {
                            const prevMod = this.modules[index - 1];
                            const prevRes = await fetch(prevMod.url);
                            if (prevRes.ok) {
                                const prevHtml = await prevRes.text();
                                const prevParser = new DOMParser();
                                const prevDoc = prevParser.parseFromString(prevHtml, 'text/html');
                                const prevContent = prevDoc.getElementById('lesson-content');
                                const prevSections = prevContent.querySelectorAll('section');
                                if (prevSections.length >= 2) {
                                    const summaryContent = prevSections[1].innerHTML;
                                    summaryStep = { 
                                        type: 'read', 
                                        html: `
                                            <div class="mb-4 pb-4 border-b border-gray-200">
                                                <span class="bg-gold text-white text-xs font-bold px-2 py-1 rounded uppercase tracking-wider">Résumé</span>
                                                <h3 class="text-frBlue font-bold mt-2">Précédemment...</h3>
                                            </div>
                                            <div class="opacity-90 text-sm sm:text-base">
                                                ${summaryContent}
                                            </div>` 
                                    };
                                }
                            }
                        } catch (err) { console.warn("Could not load previous lesson summary", err); }
                    }

                    const res = await fetch(mod.url);
                    const html = await res.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    
                    const contentDiv = doc.getElementById('lesson-content');
                    let sections = Array.from(contentDiv.querySelectorAll('section'));
                    if(sections.length === 0) sections = [contentDiv];
                    
                    const readSteps = sections.map(s => ({ type: 'read', html: s.innerHTML }));
                    
                    const data = JSON.parse(doc.getElementById('lesson-data').textContent);
                    const quizSteps = (data.exercises || []).map(ex => ({ type: 'quiz', ...ex }));

                    this.lessonSteps = [...readSteps, ...quizSteps];
                    if (summaryStep) this.lessonSteps.unshift(summaryStep);

                    this.currentLessonMeta = { ...data, id: mod.id };
                    this.currentStepIdx = 0;
                    this.renderStep();

                } catch(e) { 
                    console.error(e);
                    this.container.innerHTML = `<div class="p-10 text-center text-red-500">Error loading lesson.</div>`;
                }
            },
    
            renderStep() {
                if (this.currentStepIdx >= this.lessonSteps.length) {
                    this.prepareEndReview(); 
                    return;
                }
    
                const step = this.lessonSteps[this.currentStepIdx];
                const progress = ((this.currentStepIdx + 0.5) / this.lessonSteps.length) * 100;
                
                const isStart = this.currentStepIdx === 0;
                const navBtn = isStart 
                    ? `<button onclick="app.renderMap()" class="text-gray-400 p-2"><i class="fa-solid fa-xmark text-xl"></i></button>`
                    : `<button onclick="app.prevStep()" class="text-gray-400 p-2"><i class="fa-solid fa-arrow-left text-xl"></i></button>`;
    
                let html = `
                    <div class="h-full flex flex-col bg-frCream relative">
                        <div class="px-4 py-3 flex items-center gap-3 max-w-2xl mx-auto w-full bg-frCream z-30 shrink-0 border-b border-gray-100/50">
                            ${navBtn}
                            <div class="flex-1 h-3 bg-gray-200 rounded-full overflow-hidden shadow-inner">
                                <div class="h-full bg-green-500 transition-all duration-500 ease-out" style="width: ${progress}%"></div>
                            </div>
                        </div>
                        <div class="flex-1 overflow-y-auto px-4 w-full animate-slide-in">
                            <div class="max-w-2xl mx-auto w-full flex flex-col justify-start pb-36 pt-4">
                `;
    
                if (step.type === 'read') {
                    html += `<div class="lesson-section bg-white p-5 sm:p-8 rounded-xl shadow-sm border border-gray-100">${step.html}</div>`;
                } else if (step.type === 'quiz') {
                    html += `
                        <h2 class="text-xl font-bold text-frBlue mb-4 font-serif mt-2">Comment dit-on...</h2>
                        <div class="bg-white p-5 sm:p-8 rounded-xl shadow-card border border-gray-100 mb-4">
                            <p class="text-lg italic text-gray-600 mb-4 font-serif">"${step.q}"</p>
                            <textarea id="inp-quiz" class="w-full p-3 text-lg border-2 border-gray-200 rounded-lg focus:border-frBlue focus:outline-none transition bg-gray-50 resize-none" rows="3" placeholder="Tapez en français..."></textarea>
                        </div>
                        <div id="feedback" class="hidden rounded-lg p-4 font-bold text-center text-sm sm:text-base"></div>
                    `;
                }
    
                html += `
                            </div>
                        </div>
                        <div class="fixed bottom-0 left-0 w-full bg-white/95 backdrop-blur border-t border-gray-200 p-4 z-40 safe-pb">
                            <div class="max-w-2xl mx-auto">
                                ${step.type === 'read' 
                                    ? `<button onclick="app.nextStep()" class="w-full bg-frBlue text-white font-bold py-4 rounded-xl shadow-btn active:shadow-none active:translate-y-1 transition uppercase tracking-wider text-sm">Continuer</button>`
                                    : `<button id="btn-check" onclick="app.checkAnswer('${step.a.replace(/'/g,"\\'")}')" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-4 rounded-xl shadow-btn active:shadow-none active:translate-y-1 transition uppercase tracking-wider text-sm">Vérifier</button>
                                       <button id="btn-next" onclick="app.nextStep()" class="hidden w-full bg-green-500 text-white font-bold py-4 rounded-xl shadow-btn active:shadow-none active:translate-y-1 transition uppercase tracking-wider text-sm">Continuer</button>`
                                }
                            </div>
                        </div>
                    </div>
                `;
                this.container.innerHTML = html;
                if(step.type === 'quiz') {
                    setTimeout(() => {
                        if(window.innerWidth > 768) document.getElementById('inp-quiz').focus();
                    }, 100);
                }
            },
    
            prevStep() {
                if (this.currentStepIdx > 0) {
                    this.currentStepIdx--;
                    this.renderStep();
                }
            },
    
            checkAnswer(correct) {
                const inp = document.getElementById('inp-quiz');
                const feed = document.getElementById('feedback');
                const btnCheck = document.getElementById('btn-check');
                const btnNext = document.getElementById('btn-next');
                
                const user = inp.value.trim().toLowerCase().replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,"");
                const ans = correct.toLowerCase().replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,"");
    
                if (user === ans) {
                    inp.classList.add('border-green-500', 'bg-green-50');
                    inp.classList.remove('border-gray-200');
                    feed.innerHTML = `<div class="flex items-center justify-center gap-2 text-green-700"><i class="fa-solid fa-circle-check text-xl"></i> <span>Excellent !</span></div>`;
                    feed.className = "mb-4 rounded-xl p-4 font-bold text-center bg-green-100 animate-bounce";
                    const audio = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3');
                    audio.volume = 0.3; audio.play().catch(e=>{});
                    inp.blur(); 
                    btnCheck.classList.add('hidden');
                    btnNext.classList.remove('hidden');
                } else {
                    inp.classList.add('border-frRed', 'bg-red-50', 'animate-pulse');
                    feed.innerHTML = `<div class="text-frRed mb-1 text-xs uppercase">Réponse correcte</div><div class="text-gray-800 text-lg">${correct}</div>`;
                    feed.className = "mb-4 rounded-xl p-4 font-bold text-center bg-red-100";
                    feed.classList.remove('hidden');
                }
            },
    
            nextStep() { this.currentStepIdx++; this.renderStep(); },
    
            // --- 4. END LESSON & REVIEW ---
    
            prepareEndReview() {
                if (this.currentLessonMeta.vocabulary) {
                    const existing = this.userVocab.map(v => v.fr);
                    this.currentLessonMeta.vocabulary.forEach(w => {
                        if(!existing.includes(w.fr)) this.userVocab.push(w);
                    });
                    localStorage.setItem('acad_user_vocab', JSON.stringify(this.userVocab));
                }
    
                if (this.userVocab.length === 0) {
                    this.completeLesson(); 
                    return;
                }
    
                this.reviewDeck = [...this.userVocab].sort(() => Math.random() - 0.5).slice(0, 40);
                this.reviewIndex = 0;
    
                this.container.innerHTML = `
                    <div class="h-full flex flex-col items-center justify-center bg-frBlue text-white p-6 text-center animate-slide-in">
                        <i class="fa-solid fa-brain text-5xl mb-6 text-gold animate-pulse"></i>
                        <h2 class="text-2xl font-serif font-bold mb-4">Repaso Final</h2>
                        <p class="mb-8 max-w-xs text-sm opacity-90">Para completar la lección, debes repasar ${this.reviewDeck.length} palabras.</p>
                        <button onclick="app.renderReviewCard()" class="bg-gold text-frBlue font-bold py-3 px-10 rounded-xl shadow-lg active:scale-95 transition">Comenzar</button>
                    </div>
                `;
            },
    
            renderReviewCard() {
                if (this.reviewIndex >= this.reviewDeck.length) {
                    this.completeLesson();
                    return;
                }
    
                const word = this.reviewDeck[this.reviewIndex];
                const progress = ((this.reviewIndex) / this.reviewDeck.length) * 100;

                const isFrenchFront = Math.random() > 0.5;
                
                const frontLang = isFrenchFront ? 'Français' : 'Español';
                const frontText = isFrenchFront ? word.fr : word.es;
                
                const backLang = isFrenchFront ? 'Español' : 'Français';
                const backText = isFrenchFront ? word.es : word.fr;
    
                this.container.innerHTML = `
                    <div class="h-full flex flex-col bg-gray-100">
                        <div class="bg-frBlue p-4 text-white flex justify-between items-center shrink-0">
                            <span class="font-bold text-gold text-sm">REPASO</span>
                            <span class="text-xs opacity-75">${this.reviewIndex + 1} / ${this.reviewDeck.length}</span>
                        </div>
                        <div class="h-1 w-full bg-gray-300 shrink-0">
                            <div class="h-full bg-gold transition-all" style="width: ${progress}%"></div>
                        </div>
                        
                        <div class="flex-1 flex items-center justify-center perspective-1000 cursor-pointer group p-4 overflow-hidden" onclick="document.querySelector('.card-inner').classList.toggle('rotate-y-180')">
                            <div class="card-inner w-[85vw] max-w-xs h-[50vh] min-h-[300px] relative transform-style-3d transition-transform duration-500">
                                <!-- Front -->
                                <div class="absolute inset-0 bg-white rounded-2xl shadow-xl flex flex-col items-center justify-center backface-hidden border-b-4 border-gray-200 p-4 text-center">
                                    <span class="text-[10px] uppercase tracking-widest text-gray-400 mb-2">${frontLang}</span>
                                    <h2 class="text-2xl sm:text-3xl font-serif font-bold text-frBlue break-words max-w-full">${frontText}</h2>
                                    <p class="mt-8 text-gray-300 text-xs flex items-center gap-1"><i class="fa-solid fa-hand-pointer"></i> Toca para voltear</p>
                                </div>
                                <!-- Back -->
                                <div class="absolute inset-0 bg-frBlue rounded-2xl shadow-xl flex flex-col items-center justify-center backface-hidden rotate-y-180 text-white border-b-4 border-blue-900 p-4 text-center">
                                    <span class="text-[10px] uppercase tracking-widest text-blue-300 mb-2">${backLang}</span>
                                    <h2 class="text-2xl sm:text-3xl font-serif font-bold break-words max-w-full">${backText}</h2>
                                </div>
                            </div>
                        </div>
                        
                        <div class="p-4 bg-white border-t border-gray-200 shrink-0 safe-pb">
                            <button onclick="app.nextReviewCard()" class="w-full bg-frBlue text-white font-bold py-4 rounded-xl shadow-btn active:shadow-none active:translate-y-1 transition uppercase tracking-wider text-sm">Siguiente</button>
                        </div>
                    </div>`;
            },
    
            nextReviewCard() {
                this.reviewIndex++;
                this.renderReviewCard();
            },
    
            completeLesson() {
                const id = this.currentLessonMeta.id;
                
                // Increment count
                this.progress[id] = (this.progress[id] || 0) + 1;
                localStorage.setItem('acad_progress', JSON.stringify(this.progress));
                
                const count = this.progress[id];
                let medalTitle = "¡Nivel Bronce!";
                let medalColor = "text-bronze";
                let icon = "fa-check";
                
                if(count === 2) {
                    medalTitle = "¡Nivel Plata!";
                    medalColor = "text-gray-400"; // Silver look
                    icon = "fa-check-double";
                } else if (count >= 3) {
                    medalTitle = "¡Nivel ORO!";
                    medalColor = "text-gold";
                    icon = "fa-trophy";
                }
    
                confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
    
                this.container.innerHTML = `
                    <div class="h-full flex flex-col items-center justify-center bg-frCream p-6 text-center animate-step">
                        <div class="w-24 h-24 bg-white rounded-full flex items-center justify-center shadow-lg mb-6 text-4xl ${medalColor} border-4 border-gray-100"><i class="fa-solid ${icon}"></i></div>
                        <h2 class="text-xl text-frBlue font-bold uppercase tracking-wider mb-1">Lección Completada</h2>
                        <h1 class="text-3xl font-serif font-bold ${medalColor} mb-6">${medalTitle}</h1>
                        <p class="text-gray-500 mb-8 text-sm max-w-xs">
                            Has completado esta lección ${count} ${count === 1 ? 'vez' : 'veces'}. 
                            ${count < 3 ? '<br>¡Repite para subir de nivel!' : '<br>¡Eres un maestro!'}
                        </p>
                        <div class="w-full max-w-sm space-y-4">
                            <button onclick="app.renderMap()" class="w-full bg-frBlue text-white font-bold py-4 rounded-xl shadow-lg active:scale-95 transition">Volver al Mapa</button>
                        </div>
                    </div>`;
            },
            
            // --- 5. VOLUNTARY FLASHCARDS ---
            renderFlashcards() {
                if(this.userVocab.length === 0) {
                    this.container.innerHTML = `<div class="h-full flex items-center justify-center flex-col p-6 text-center"><p class="text-gray-500 mb-4">No tienes vocabulario guardado aún.</p><button class="text-frBlue font-bold border border-frBlue px-4 py-2 rounded-lg" onclick="app.renderMap()">Volver</button></div>`;
                    return;
                }
                this.deck = [...this.userVocab].sort(()=>Math.random()-0.5);
                this.cardIdx = 0;
                this.renderVoluntaryCard();
            },
            
            renderVoluntaryCard() {
                if(this.cardIdx >= this.deck.length) {
                    this.container.innerHTML = `<div class="h-full flex items-center justify-center flex-col bg-frBlue text-white"><h2 class="text-xl font-bold mb-4">¡Repaso terminado!</h2><button onclick="app.renderMap()" class="bg-white/20 px-6 py-3 rounded-lg hover:bg-white/30 transition">Volver</button></div>`;
                    return;
                }
                const word = this.deck[this.cardIdx];

                const isFrenchFront = Math.random() > 0.5;
                
                const frontLang = isFrenchFront ? 'Français' : 'Español';
                const frontText = isFrenchFront ? word.fr : word.es;
                
                const backLang = isFrenchFront ? 'Español' : 'Français';
                const backText = isFrenchFront ? word.es : word.fr;

                this.container.innerHTML = `
                    <div class="h-full flex flex-col bg-gray-100">
                        <div class="p-4 flex justify-end"><button onclick="app.renderMap()" class="bg-gray-200 rounded-full w-8 h-8 flex items-center justify-center"><i class="fa-solid fa-xmark text-gray-500"></i></button></div>
                        <div class="flex-1 flex items-center justify-center perspective-1000 cursor-pointer group px-4" onclick="document.querySelector('.card-inner').classList.toggle('rotate-y-180')">
                            <div class="card-inner w-full max-w-[300px] h-[400px] relative transform-style-3d transition-transform duration-500">
                                <div class="absolute inset-0 bg-white rounded-2xl shadow-xl flex flex-col items-center justify-center backface-hidden border-b-4 border-gray-200">
                                    <span class="text-xs uppercase tracking-widest text-gray-400 mb-2">${frontLang}</span>
                                    <h2 class="text-3xl font-serif font-bold text-frBlue text-center px-2">${frontText}</h2>
                                </div>
                                <div class="absolute inset-0 bg-frBlue rounded-2xl shadow-xl flex flex-col items-center justify-center backface-hidden rotate-y-180 text-white border-b-4 border-blue-900">
                                    <span class="text-xs uppercase tracking-widest text-blue-300 mb-2">${backLang}</span>
                                    <h2 class="text-3xl font-serif font-bold text-center px-2">${backText}</h2>
                                </div>
                            </div>
                        </div>
                        <div class="p-6 pb-8 flex gap-4 justify-center">
                            <button onclick="app.nextVoluntaryCard()" class="bg-white border-2 border-gray-200 px-8 py-4 rounded-xl font-bold text-gray-600 w-full shadow-sm">Siguiente</button>
                        </div>
                    </div>`;
            },
            nextVoluntaryCard() { this.cardIdx++; this.renderVoluntaryCard(); }
        };
        app.init();
    </script>
</body>
</html>